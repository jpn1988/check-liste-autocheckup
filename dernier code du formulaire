import tkinter as tk
from tkinter import filedialog, messagebox
from tkinter import ttk  # Importation nécessaire pour utiliser ttk.Separator

class StarRating(tk.Frame):
    def __init__(self, parent, max_stars=5, command=None):
        super().__init__(parent)
        self.command = command
        self.stars = []
        self.var = tk.IntVar(value=0)  # Variable pour stocker la note sélectionnée

        for i in range(1, max_stars + 1):
            star = tk.Label(self, text=f"{i}", width=2, relief=tk.RAISED, bg="lightgray")
            star.grid(row=0, column=i-1, padx=2)
            star.bind("<Button-1>", self.on_click)
            star.bind("<Enter>", self.on_enter)
            star.bind("<Leave>", self.on_leave)
            self.stars.append(star)

    def on_click(self, event):
        selected_star = int(event.widget.cget("text"))
        self.var.set(selected_star)
        self.update_stars(selected_star)
        if self.command:
            self.command(selected_star)

    def on_enter(self, event):
        hover_star = int(event.widget.cget("text"))
        self.update_stars(hover_star)

    def on_leave(self, event):
        self.update_stars(self.var.get())

    def update_stars(self, selected_star):
        for i, star in enumerate(self.stars, start=1):
            if i <= selected_star:
                star.config(bg="yellow", relief=tk.SUNKEN)
            else:
                star.config(bg="lightgray", relief=tk.RAISED)

class Section(tk.Frame):
    def __init__(self, parent, section_name, total_questions, toggle_command):
        super().__init__(parent)
        self.section_name = section_name
        self.total_questions = total_questions
        self.answered_count = 0
        self.vars = []
        self.toggle_command = toggle_command

        self.button = tk.Button(parent, text=f"{section_name} (0/{total_questions})", command=self.toggle_section)
        self.button.pack(fill="x", padx=10, pady=5)

        self.frame = tk.LabelFrame(parent, text=f"Questions {section_name}")
        self.frame.pack(fill="both", expand="yes", padx=10, pady=10)
        self.frame.pack_forget()  # Masquer par défaut

        self.create_questions()

    def create_questions(self):
        self.add_field("Corrosion")
        self.add_separator()
        self.add_field("Rayure")
        self.add_separator()
        self.add_field("Impact")
        self.add_separator()
        self.add_field("Défaut de peinture")
        self.add_separator()
        self.add_field("Défaut d'alignement")
        self.add_separator()
        self.add_field("Autre défaut")
        self.add_separator()

        # Ajout de l'évaluation de l'état visuel général avec des étoiles
        tk.Label(self.frame, text="Évaluez l’état visuel général de 1 à 5 ?", anchor="w").pack(anchor="w", pady=(10, 0))
        star_rating = StarRating(self.frame, command=self.on_star_selected)
        star_rating.pack(anchor="w", padx=20, pady=(0, 10))  # Uniformiser le padding et l'alignement avec les autres éléments

        self.vars.append(star_rating.var)

        # Séparateur entre l'état visuel général et le commentaire
        self.add_separator()

        # Ajouter la question "Ajouter un commentaire ?"
        self.add_field("Ajouter un commentaire")
        self.add_separator()

    def add_field(self, label_text):
        label = tk.Label(self.frame, text=f"{label_text} ?", anchor="w")
        label.pack(anchor="w")

        variable = tk.StringVar(value="")
        self.vars.append(variable)

        # Créez les boutons radio avec des fonctions de rappel pour activer/désactiver le bouton de photo
        rb1 = tk.Radiobutton(self.frame, text="OUI", variable=variable, value="OUI", cursor="hand2", indicatoron=0,
                             command=lambda: self.handle_answer(variable, label, button_photo))
        rb2 = tk.Radiobutton(self.frame, text="NON", variable=variable, value="NON", cursor="hand2", indicatoron=0,
                             command=lambda: self.handle_answer(variable, label))

        rb1.pack(anchor="w")
        rb2.pack(anchor="w")

        # Créez le bouton de prise de photo, désactivé par défaut, placé sous les boutons radio
        button_photo = tk.Button(self.frame, text=f"Prenez une photo de {label_text.lower()}", command=lambda: self.upload_photo(label), state="disabled")
        button_photo.pack(anchor="w", padx=20, pady=(0, 10))  # Uniformiser le padding et l'alignement avec les autres éléments

    def add_separator(self):
        separator = ttk.Separator(self.frame, orient="horizontal")
        separator.pack(fill="x", pady=5)  # Espacement entre les questions

    def handle_answer(self, variable, label, button_photo=None):
        # Si "OUI" est sélectionné, activer le bouton de photo
        if variable.get() == "OUI" and button_photo:
            button_photo.config(state="normal")
        else:
            # Ajouter une coche directement si "NON" est sélectionné
            if "✓" not in label.cget('text'):
                label.config(text=f"{label.cget('text')} ✓")
                self.answered_count += 1
                self.update_button_text()

    def on_star_selected(self, rating):
        # Identification précise du label de l'état visuel général
        for widget in self.frame.winfo_children():
            if isinstance(widget, tk.Label) and "Évaluez l’état visuel général" in widget.cget("text"):
                label = widget
                break
        
        # Mise à jour du label avec une coche
        if "✓" not in label.cget('text'):
            label.config(text=f"{label.cget('text')} ✓")
            self.answered_count += 1
            self.update_button_text()

    def upload_photo(self, label):
        file = filedialog.askopenfilename(filetypes=[("Image files", "*.jpg;*.jpeg;*.png;*.gif")])
        if file:
            messagebox.showinfo("Fichier sélectionné", f"Fichier sélectionné : {file}")
            if "✓" not in label.cget('text'):
                label.config(text=f"{label.cget('text')} ✓")
                self.answered_count += 1
                self.update_button_text()

    def update_button_text(self):
        # Met à jour le texte du bouton avec le nombre de questions répondues
        checkmark = " ✓" if self.answered_count == self.total_questions else ""
        self.button.config(text=f"{self.section_name} ({self.answered_count}/{self.total_questions}){checkmark}")

    def toggle_section(self):
        if self.frame.winfo_viewable():
            self.frame.pack_forget()  # Masquer les questions
        else:
            self.toggle_command(self)  # Ferme les autres sections avant d'ouvrir celle-ci
            self.frame.pack(fill="both", expand="yes", padx=10, pady=10)  # Afficher les questions

class InspectionForm(tk.Tk):
    def __init__(self):
        super().__init__()
        self.title("Inspection de l'éclairage et du vitrage")
        self.geometry("600x800")  # Fixe une taille initiale

        # Création du cadre principal avec barre de défilement
        container = tk.Frame(self)
        container.pack(fill="both", expand=True)

        canvas = tk.Canvas(container)
        scrollbar = tk.Scrollbar(container, orient="vertical", command=canvas.yview)
        self.scrollable_frame = tk.Frame(canvas)

        self.scrollable_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(
                scrollregion=canvas.bbox("all")
            )
        )

        canvas.create_window((0, 0), window=self.scrollable_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)

        canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")

        # Création des sections
        self.sections = []
        self.sections.append(Section(self.scrollable_frame, "Capot", 8, self.close_other_sections))
        self.sections.append(Section(self.scrollable_frame, "Parechoc", 8, self.close_other_sections))  # Ajout de la section Parechoc

        # Bouton de soumission
        self.submit_button = tk.Button(self.scrollable_frame, text="Soumettre", command=self.submit)
        self.submit_button.pack(pady=10)

    def close_other_sections(self, current_section):
        for section in self.sections:
            if section != current_section and section.frame.winfo_viewable():
                section.frame.pack_forget()

    def submit(self):
        all_answered = all(section.answered_count == section.total_questions for section in self.sections)
        if not all_answered:
            messagebox.showwarning("Formulaire incomplet", "Veuillez répondre à toutes les questions avant de soumettre le formulaire.")
        else:
            response = messagebox.askyesno("Confirmation", "Voulez-vous vraiment soumettre le formulaire ?")
            if response:
                messagebox.showinfo("Soumission", "Formulaire soumis avec succès !")
            else:
                messagebox.showinfo("Annulation", "Soumission annulée.")

if __name__ == "__main__":
    app = InspectionForm()
    app.mainloop()
